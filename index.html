<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/th.js"></script>
  <style>
    body { font-family: 'Tahoma', sans-serif; max-width: 480px; margin: auto; padding: 20px; background: #f4f7f8; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    h2 { text-align: center; color: #0066cc; }
    label { display: block; margin: 10px 0 5px; font-weight: bold; }
    input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 10px; width: 100%; font-size: 16px; border: none; border-radius: 8px; background-color: #28a745; color: white; cursor: pointer; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    button:hover:not(:disabled) { background-color: #218838; }
    .msg { margin-top: 15px; font-size: 16px; text-align: center; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£</h2>
  <div id="userInfo" style="display:none;">
    üë§ <span id="displayName"></span><br>
    üÜî <span id="userId"></span>
  </div>
  <form id="registerForm" style="display:none;">
    <label for="licenseNo">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï ‡πÄ‡∏ä‡πà‡∏ô 1/2568</label>
    <input type="text" id="licenseNo" required pattern="^\d{1,4}/25\d{2}$" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å/‡∏õ‡∏µ‡∏û.‡∏®. ‡πÄ‡∏ä‡πà‡∏ô 123/2568">
    <small id="licenseError" style="color: red; display: none;">‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å/‡∏õ‡∏µ‡∏û.‡∏®. ‡πÄ‡∏ä‡πà‡∏ô 123/2568</small>

    <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</label>
    <input type="text" id="citizenId" required>

    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•/‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£</label>
    <input type="text" id="fullName" required>

    <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£</label>
    <select id="businessType" required>
      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (80)">‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (80)</option>
      <option value="‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (70)">‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (70)</option>
      <option value="‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (40)">‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (40)</option>
      <option value="‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (30)">‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (30)</option>
      <option value="‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (10)">‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (10)</option>
      <option value="‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (80 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)">‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (80 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</option>
      <option value="‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (70 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)">‡∏£‡∏ñ‡∏ö‡∏£‡∏£‡∏ó‡∏∏‡∏Å‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (70 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</option>
      <option value="‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (30 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)">‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á (30 ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®)</option>
    </select>

    <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</label>
    <input type="text" id="approveDate" required>
    <label>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
    <input type="text" id="expireDate" required>

    <button type="submit" id="submitBtn">‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
    <div class="msg" id="msg"></div>
  </form>

<script>
const liffId = "2007647972-rZOy6klP"; 
const postUrl = "https://script.google.com/macros/s/AKfycbxMv44V7VE16_OXWgb4ue4LF6GJgd4wkEpn1i3LLWVFwb1VCxz-f9pdFhFjvfXzThvFRA/exec";

async function main() {
  await liff.init({ liffId });
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: location.href });
    return;
  }

  const profile = await liff.getProfile();
  document.getElementById("displayName").textContent = profile.displayName;
  document.getElementById("userId").textContent = profile.userId;
  document.getElementById("userInfo").style.display = "block";
  document.getElementById("registerForm").style.display = "block";

  const submitBtn = document.getElementById("submitBtn");

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
  const licenseInput = document.getElementById("licenseNo");
  const licenseError = document.getElementById("licenseError");
  const regexLicense = /^\d{1,4}\/25\d{2}$/;

  licenseInput.addEventListener("keypress", e => {
    const allowed = /[0-9\/]/;
    if (!allowed.test(e.key)) e.preventDefault();
  });
  licenseInput.addEventListener("input", () => {
    licenseError.style.display = licenseInput.value && !regexLicense.test(licenseInput.value) ? "block" : "none";
  });

  // ‚úÖ Flatpickr ‡πÅ‡∏™‡∏î‡∏á ‡∏û.‡∏®.
  const toBuddhistYear = (dateStr) => {
    const d = new Date(dateStr);
    return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
  };

  flatpickr("#approveDate", {
    locale: "th",
    dateFormat: "Y-m-d",
    onReady: (sel, dateStr, inst) => {
      if(dateStr) inst._input.value = toBuddhistYear(dateStr);
    },
    onChange: (sel, dateStr, inst) => {
      inst._input.value = toBuddhistYear(dateStr);
      inst._input.dataset.ad = dateStr; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ ‡∏Ñ.‡∏®.
    }
  });

  flatpickr("#expireDate", {
    locale: "th",
    dateFormat: "Y-m-d",
    onReady: (sel, dateStr, inst) => {
      if(dateStr) inst._input.value = toBuddhistYear(dateStr);
    },
    onChange: (sel, dateStr, inst) => {
      inst._input.value = toBuddhistYear(dateStr);
      inst._input.dataset.ad = dateStr;
    }
  });

  document.getElementById("registerForm").addEventListener("submit", e => {
    e.preventDefault();
    submitBtn.disabled = true;

    const citizenId = document.getElementById("citizenId").value;
    if (!/^\d{13}$/.test(citizenId)) {
      document.getElementById("msg").textContent = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô/‡∏ô‡∏¥‡∏ï‡∏¥‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 13 ‡∏´‡∏•‡∏±‡∏Å";
      document.getElementById("msg").className = "msg error";
      submitBtn.disabled = false;
      return;
    }

    const params = new URLSearchParams({
      action: "register",
      userId: profile.userId,
      displayName: profile.displayName,
      licenseNo: "'" + document.getElementById("licenseNo").value,
      citizenId: "'" + citizenId,
      fullName: document.getElementById("fullName").value,
      businessType: document.getElementById("businessType").value,
      approveDate: document.getElementById("approveDate").dataset.ad || "",
      expireDate: document.getElementById("expireDate").dataset.ad || ""
    });

    fetch(`${postUrl}?${params.toString()}`, { method: "GET" })
      .then(res => res.text())
      .then(text => {
        if (text === "OK") {
          document.getElementById("msg").textContent = "‚úÖ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
          document.getElementById("msg").className = "msg success";
          document.getElementById("registerForm").reset();
        } else {
          document.getElementById("msg").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ";
          document.getElementById("msg").className = "msg error";
        }
        submitBtn.disabled = false;
      })
      .catch(() => {
        document.getElementById("msg").textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
        document.getElementById("msg").className = "msg error";
        submitBtn.disabled = false;
      });
  });
}

main();
</script>
</body>
</html>
